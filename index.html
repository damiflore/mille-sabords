<!DOCTYPE html>
<html>
  <head>
    <title>Mille sabords</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="./favicon.png" />
    <script type="importmap" src="./importmap.prod.importmap"></script>
  </head>

  <body>
    <div id="splashscreen" data-visible>
      <style>
        #splashscreen[data-visible] + #app {
          visibility: hidden;
          /*
          avoid big image to create a scroll
          or if the game is too big it will
          increase splashscreen size
          */
          width: 100%;
          height: 100%;
          overflow: hidden;
        }

        #splashscreen[data-visible] {
          display: flex;
        }

        #splashscreen {
          position: fixed;
          z-index: 1000;
          left: 0;
          top: 0;
          right: 0;
          bottom: 0;
          background: black;
          color: white;
          display: none;
          flex-direction: column;
          align-items: center;
        }

        #splashscreen #splashscreen-text {
          display: flex;
          visibility: hidden;
          align-items: center;
          flex: 1;
        }

        #splashscreen #errorscreen {
          display: block;
        }

        #splashscreen #errorscreen details {
          max-width: 500px;
        }
        #splashscreen details pre {
          overflow: auto;
        }
      </style>
      <h1>Mille sabords</h1>
      <div id="splashscreen-text" hidden>Hey ça load</div>
      <script>
        const splashscreenTextElement = document.querySelector("#splashscreen-text")
        const timeout = setTimeout(() => {
          // montre un loader ou quelque chose parce que le site met un peu de temps a se load
          splashscreenTextElement.style.visibility = "visible"
        }, 700)

        const errorEventCallback = (errorEvent) => {
          window.removeEventListener("error", errorEventCallback)
          window.splashscreen.onMainScriptSyntaxOrRunTimeError({
            message: errorEvent.message,
            filename: errorEvent.filename,
            lineNumber: errorEvent.lineno,
            columnNumber: errorEvent.colno,
          })
        }
        window.addEventListener("error", errorEventCallback)

        window.splashscreen = {
          onMainScriptLoadError: () => {
            splashscreenTextElement.innerHTML = `<div id="errorscreen">
Une erreur est survenue pendant le chargement du fichier principal du jeu
</div>`
          },
          onMainScriptSyntaxOrRunTimeError: (error) => {
            splashscreenTextElement.innerHTML = `<div id="errorscreen">
  <p>Le fichier principal du jeu contient une erreur.</p>
  <br />
  <details>
    <summary>Voir le détail</summary>
    <h6>${error.filename}:${error.lineNumber}:${error.columnNumber}</h6>
    <pre>${error.message}</pre>
  </details>
</div>`
          },
          remove: () => {
            clearTimeout(timeout)
            window.removeEventListener("error", errorEventCallback)
            document.querySelector("#splashscreen").removeAttribute("data-visible")
          },
        }
      </script>
    </div>
    <div id="app"></div>
    <script id="main-script" type="module" src="./index.js"></script>
    <script async>
      const mainScript = document.querySelector("script#main-script")
      mainScript.onerror = () => {
        window.splashscreen.onMainScriptLoadError()
      }
    </script>
  </body>
</html>
